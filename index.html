<html>
  <head>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; font-family: sans-serif; }

      /* Glassmorphic Map UI */
      #map {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 220px;
        padding: 15px;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        color: #fff;
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      }
      #map h3 { margin: 0 0 10px; font-size: 16px; text-align: center; }
      .legend { font-size: 13px; margin-top: 10px; line-height: 1.4em; }
      .marker { font-weight: bold; color: #ff4444; }

      /* Joystick */
      #joystick {
        position: fixed;
        bottom: 40px;
        left: 40px;
        width: 120px;
        height: 120px;
        touch-action: none; /* important for mobile */
      }
    </style>
  </head>
  <body>
    <a-scene background="color: #101010">

      <!-- LIGHTS -->
      <a-entity light="type: directional; intensity: 1; castShadow: true" position="2 4 5"></a-entity>
      <a-entity light="type: ambient; intensity: 0.8"></a-entity>

      <!-- Optional sky to prevent black pixels -->
      <a-sky color="#101010"></a-sky>

      <!-- OPEN PIT MINE MODEL -->
      <a-entity id="mine"
        gltf-model="mine_ar_map.glb"
        position="0 0 -6"
        scale="6 6 6"
        rotation="0 20 0">
      </a-entity>

      <!-- CAMERA RIG -->
      <a-entity id="rig" position="0 1.6 3">
        <a-camera wasd-controls-enabled="false" look-controls="enabled: true"></a-camera>
      </a-entity>
    </a-scene>

    <!-- Joystick container -->
    <div id="joystick"></div>

    <!-- Map overlay -->
    <div id="map">
      <h3>Mine Map</h3>
      <div class="legend">
        <span class="marker">1</span> Loading Area<br>
        <span class="marker">2</span> Excavation Zone<br>
        <span class="marker">3</span> Control Station
      </div>
    </div>

    <script>
      const rig = document.querySelector("#rig");
      let moveX = 0, moveZ = 0;

      // Setup joystick
      const joystick = nipplejs.create({
        zone: document.getElementById("joystick"),
        mode: "static",
        position: { left: 60, bottom: 60 },
        color: "lime",
        size: 120
      });

      joystick.on("move", (evt, data) => {
        if (!data.angle || !data.force) return;
        const angle = data.angle.radian;
        const force = data.force;
        moveX = Math.sin(angle) * force * 0.03;  // A-Frame X axis
        moveZ = -Math.cos(angle) * force * 0.03; // negative Z is forward
      });

      joystick.on("end", () => { moveX = 0; moveZ = 0; });

      // Smooth movement
      function tick() {
        let pos = rig.getAttribute("position");
        rig.setAttribute("position", {
          x: pos.x + moveX,
          y: pos.y,
          z: pos.z + moveZ
        });
        requestAnimationFrame(tick);
      }
      tick();
    </script>
  </body>
</html>
