<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
  <title>Mine VR ‚Äî Complete Build</title>

  <!-- A-Frame + nipplejs -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>

  <style>
    html, body { 
      margin: 0; 
      padding: 0; 
      height: 100%; 
      background: #0f0f10; 
      color: #fff; 
      font-family: Arial, sans-serif; 
    }
    
    a-scene { 
      height: 100vh; 
      width: 100vw; 
      display: block; 
    }

    /* Joystick styling */
    #joystick {
      position: fixed;
      bottom: 30px;
      left: 30px;
      width: 140px;
      height: 140px;
      background: rgba(57, 255, 20, 0.1);
      border: 2px solid rgba(57, 255, 20, 0.4);
      border-radius: 50%;
      z-index: 1000;
      box-shadow: 0 0 30px rgba(57, 255, 20, 0.3);
      touch-action: none;
    }

    /* Map UI - glassmorphic */
    #map {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 220px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      color: white;
      z-index: 1000;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    #map h3 {
      margin: 0 0 12px 0;
      text-align: center;
      font-size: 16px;
    }
    
    .marker {
      color: #39ff14;
      cursor: pointer;
      font-weight: bold;
      padding: 4px 8px;
      display: inline-block;
      margin-right: 8px;
      border-radius: 4px;
      text-shadow: 0 0 8px rgba(57, 255, 20, 0.5);
      transition: all 0.2s ease;
    }
    
    .marker:hover, .marker:active {
      background: rgba(57, 255, 20, 0.2);
      transform: scale(1.1);
    }

    /* Status panel */
    #status {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 12px;
      border-radius: 8px;
      font-size: 12px;
      max-width: 300px;
      z-index: 1000;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .status-line {
      margin: 4px 0;
      font-family: monospace;
    }

    .ok { color: #7ef9a6; }
    .warn { color: #ffd36b; }
    .err { color: #ff8b8b; }

    /* Mobile responsive */
    @media (max-width: 480px) {
      #map { width: 180px; right: 15px; top: 15px; padding: 12px; }
      #joystick { width: 120px; height: 120px; left: 20px; bottom: 20px; }
      #status { width: 250px; left: 15px; top: 15px; }
    }

    /* VR button styling */
    .a-enter-vr-button {
      background: rgba(57, 255, 20, 0.9) !important;
      border: none !important;
      border-radius: 6px !important;
    }
  </style>
</head>
<body>

  <a-scene embedded 
           renderer="antialias: true; physicallyCorrectLights: true"
           vr-mode-ui="enabled: true">
    
    <!-- Assets - YOUR GLB MODEL -->
    <a-assets timeout="20000">
      <a-asset-item id="mineModel" src="mine_ar_map.glb" crossorigin="anonymous"></a-asset-item>
    </a-assets>
    
    <!-- Environment -->
    <a-sky color="#1a1a2e"></a-sky>
    <a-plane position="0 0 -4" rotation="-90 0 0" width="30" height="30" color="#2a2a2a" shadow="receive: true"></a-plane>
    
    <!-- Lighting setup -->
    <a-light type="ambient" color="#404040" intensity="0.6"></a-light>
    <a-light type="directional" position="5 8 3" color="#ffffff" intensity="1.0" shadow="cast: true"></a-light>
    <a-light type="point" position="2 3 -2" color="#39ff14" intensity="0.5" distance="10"></a-light>
    <a-light type="point" position="-3 3 -6" color="#ff6b35" intensity="0.4" distance="8"></a-light>
    
    <!-- YOUR GLB MODEL -->
    <a-entity id="mine" 
              gltf-model="#mineModel" 
              position="0 0 -6" 
              rotation="0 20 0" 
              scale="6 6 6"
              shadow="cast: true; receive: true">
    </a-entity>
    
    <!-- FALLBACK CONTENT (visible until GLB loads) -->
    <a-entity id="fallback-mine" visible="true" position="0 0 -6">
      <!-- Main mine structure -->
      <a-box position="0 1 0" width="10" height="2" depth="15" color="#444444" shadow="cast: true; receive: true">
        <a-text value="MINE COMPLEX" position="0 1.5 0" align="center" color="#39ff14" scale="1.5 1.5 1.5"></a-text>
      </a-box>
      
      <!-- Zone 1: Loading Area -->
      <a-box position="3 0.5 2" width="3" height="1" depth="3" color="#39ff14" shadow="cast: true; receive: true">
        <a-text value="1\nLOADING AREA" position="0 1 0" align="center" color="#000000" scale="1 1 1"></a-text>
      </a-box>
      
      <!-- Zone 2: Excavation Zone -->
      <a-box position="-3 0.5 -2" width="4" height="1" depth="4" color="#ff6b35" shadow="cast: true; receive: true">
        <a-text value="2\nEXCAVATION" position="0 1 0" align="center" color="#ffffff" scale="1 1 1"></a-text>
      </a-box>
      
      <!-- Zone 3: Control Station -->
      <a-box position="1 0.5 -8" width="3" height="1.5" depth="3" color="#4ecdc4" shadow="cast: true; receive: true">
        <a-text value="3\nCONTROL" position="0 1.2 0" align="center" color="#000000" scale="1 1 1"></a-text>
      </a-box>
      
      <!-- Mining equipment -->
      <a-cylinder position="2 1 -1" radius="0.3" height="3" color="#666666" shadow="cast: true"></a-cylinder>
      <a-cylinder position="-2 0.8 -3" radius="0.2" height="2" color="#888888" shadow="cast: true"></a-cylinder>
      <a-box position="0 0.3 -5" width="1" height="0.6" depth="2" color="#555555" shadow="cast: true"></a-box>
    </a-entity>

    <!-- Camera rig -->
    <a-entity id="rig" position="0 1.8 4">
      <a-camera wasd-controls-enabled="false" 
                look-controls="enabled: true"
                fov="75">
      </a-camera>
    </a-entity>

  </a-scene>

  <!-- UI Elements -->
  <div id="joystick" aria-label="Movement joystick"></div>
  
  <div id="map" aria-label="Mine navigation map">
    <h3>üó∫Ô∏è Mine Map</h3>
    <div style="line-height: 1.8;">
      <span class="marker" data-zone="1">1</span>Loading Area<br>
      <span class="marker" data-zone="2">2</span>Excavation Zone<br>
      <span class="marker" data-zone="3">3</span>Control Station
    </div>
  </div>

  <div id="status">
    <div class="status-line ok">üöÄ Mine VR System Starting...</div>
  </div>

<script>
(function() {
  'use strict';
  
  const rig = document.querySelector('#rig');
  const statusEl = document.querySelector('#status');
  const mineModel = document.querySelector('#mine');
  const fallbackMine = document.querySelector('#fallback-mine');
  let modelLoaded = false;

  function addStatus(message, type = 'ok') {
    const line = document.createElement('div');
    line.className = `status-line ${type}`;
    line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    statusEl.prepend(line);
    
    // Keep only last 10 messages
    while (statusEl.children.length > 10) {
      statusEl.removeChild(statusEl.lastChild);
    }
    
    console.log(`[Mine VR] ${message}`);
  }

  // GLB Model event handlers
  mineModel.addEventListener('model-loaded', (evt) => {
    modelLoaded = true;
    addStatus('‚úÖ GLB model loaded successfully!', 'ok');
    
    // Hide fallback content
    fallbackMine.setAttribute('visible', 'false');
    
    // Enhance the loaded model
    try {
      const model = evt.detail.model;
      if (model) {
        model.traverse(node => {
          if (node.isMesh && node.material) {
            node.material.side = THREE.DoubleSide;
            node.material.needsUpdate = true;
            node.castShadow = true;
            node.receiveShadow = true;
          }
        });
        addStatus('üîß Model enhanced for VR', 'ok');
      }
    } catch (e) {
      addStatus('‚ö†Ô∏è Model enhancement failed: ' + e.message, 'warn');
    }
  });

  mineModel.addEventListener('model-error', () => {
    addStatus('‚ùå GLB model failed to load', 'err');
    addStatus('üí° Using interactive fallback mine', 'warn');
    fallbackMine.setAttribute('visible', 'true');
  });

  // Timeout for model loading
  setTimeout(() => {
    if (!modelLoaded) {
      addStatus('‚è∞ GLB model timeout - check file path', 'warn');
      addStatus('üìÅ Ensure mine_ar_map.glb is in same folder', 'warn');
    }
  }, 20000);

  // Joystick setup
  if (window.nipplejs) {
    const joystick = nipplejs.create({
      zone: document.getElementById('joystick'),
      mode: 'static',
      position: { left: '50%', top: '50%' },
      color: '#39ff14',
      size: 100,
      restOpacity: 0.7
    });

    let moveX = 0, moveZ = 0;
    let isMoving = false;

    joystick.on('start', () => {
      isMoving = true;
      addStatus('üïπÔ∏è Movement started', 'ok');
    });

    joystick.on('move', (evt, data) => {
      if (!data) return;
      const angle = data.angle.radian;
      const force = Math.min(data.force, 2);
      moveX = Math.sin(angle) * force * 0.03;
      moveZ = -Math.cos(angle) * force * 0.03;
    });

    joystick.on('end', () => {
      moveX = 0;
      moveZ = 0;
      isMoving = false;
      addStatus('üõë Movement stopped', 'ok');
    });

    // Movement loop
    function updateMovement() {
      try {
        const pos = rig.getAttribute('position');
        const newX = (pos.x || 0) + moveX;
        const newY = pos.y || 1.8;
        const newZ = (pos.z || 0) + moveZ;
        
        // Simple boundary check
        const clampedX = Math.max(-15, Math.min(15, newX));
        const clampedZ = Math.max(-20, Math.min(10, newZ));
        
        rig.setAttribute('position', { x: clampedX, y: newY, z: clampedZ });
      } catch (e) {
        // Silent fail
      }
      requestAnimationFrame(updateMovement);
    }
    updateMovement();

    addStatus('üéÆ Joystick controls ready', 'ok');
  } else {
    addStatus('‚ùå Joystick library not available', 'err');
  }

  // Map teleportation
  document.querySelectorAll('.marker').forEach(marker => {
    marker.addEventListener('click', (e) => {
      e.preventDefault();
      const zone = marker.getAttribute('data-zone');
      teleportToZone(parseInt(zone));
    });
    
    // Touch support
    marker.addEventListener('touchend', (e) => {
      e.preventDefault();
      const zone = marker.getAttribute('data-zone');
      teleportToZone(parseInt(zone));
    });
  });

  function teleportToZone(zone) {
    const positions = {
      1: { x: 3, y: 2, z: -4 },    // Loading Area
      2: { x: -3, y: 2, z: -8 },   // Excavation Zone  
      3: { x: 1, y: 2.5, z: -14 }  // Control Station
    };
    
    const target = positions[zone];
    if (!target) {
      addStatus(`‚ùå Unknown zone: ${zone}`, 'warn');
      return;
    }

    // Smooth teleportation
    const start = rig.getAttribute('position');
    const duration = 600;
    const startTime = performance.now();
    
    function animate(now) {
      const elapsed = now - startTime;
      const progress = Math.min(elapsed / duration, 1);
      
      // Ease in-out
      const eased = progress < 0.5 
        ? 2 * progress * progress 
        : 1 - Math.pow(-2 * progress + 2, 2) / 2;
      
      const current = {
        x: start.x + (target.x - start.x) * eased,
        y: start.y + (target.y - start.y) * eased,
        z: start.z + (target.z - start.z) * eased
      };
      
      rig.setAttribute('position', current);
      
      if (progress < 1) {
        requestAnimationFrame(animate);
      } else {
        addStatus(`‚úÖ Teleported to zone ${zone}`, 'ok');
      }
    }
    
    requestAnimationFrame(animate);
    addStatus(`üéØ Teleporting to zone ${zone}...`, 'ok');
  }

  // Initial setup
  addStatus('üèóÔ∏è Interactive fallback mine loaded', 'ok');
  addStatus('üì± Touch joystick to move around', 'ok');
  addStatus('üó∫Ô∏è Click map markers to teleport', 'ok');
  addStatus('üìÅ Place mine_ar_map.glb in same folder', 'warn');

  // Debug interface
  window.__mineVR = { 
    teleportToZone, 
    addStatus, 
    rig,
    modelLoaded: () => modelLoaded
  };

})();
</script>

</body>
</html>
