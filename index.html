<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Mine GLB Model Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
        body { 
            margin: 0; 
            background: #000; 
            color: white; 
            font-family: Arial, sans-serif; 
        }
        
        #info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            max-width: 400px;
        }
        
        .status { 
            margin: 5px 0; 
            font-size: 14px; 
        }
        
        .loading { color: #ffeb3b; }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        
        #fileInput {
            margin: 10px 0;
            padding: 5px;
            background: #333;
            border: 1px solid #666;
            color: white;
            border-radius: 4px;
            width: 200px;
        }
        
        button {
            padding: 8px 15px;
            background: #4caf50;
            border: none;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #45a049;
        }
    </style>
</head>
<body>

<div id="info">
    <h3>üèóÔ∏è Mine GLB Model Loader</h3>
    <div class="status loading">üìÅ Place your mine_ar_map.glb file in the same folder as this HTML</div>
    <div class="status loading">üåê Or serve this via HTTP server (not file://)</div>
    <br>
    <input type="text" id="fileInput" placeholder="mine_ar_map.glb" value="mine_ar_map.glb">
    <button onclick="loadModel()">üîÑ Load Model</button>
    <button onclick="testModel()">üß™ Test with Sample</button>
    <br><br>
    <div id="statusLog"></div>
</div>

<a-scene embedded style="height: 100vh; width: 100vw;" 
         renderer="antialias: true; colorManagement: true"
         background="color: #001122">
    
    <!-- Assets will be populated by JavaScript -->
    <a-assets id="assets">
    </a-assets>
    
    <!-- Lighting for the model -->
    <a-light type="ambient" intensity="0.5"></a-light>
    <a-light type="directional" position="2 4 2" intensity="1" shadow="cast: true"></a-light>
    <a-light type="point" position="0 3 0" intensity="0.8" color="#ffffff"></a-light>
    
    <!-- Ground plane -->
    <a-plane position="0 -1 -5" rotation="-90 0 0" width="20" height="20" 
             color="#333333" shadow="receive: true"></a-plane>
    
    <!-- Model will be loaded here -->
    <a-entity id="modelContainer" position="0 0 -5" rotation="0 0 0" scale="1 1 1"></a-entity>
    
    <!-- Camera -->
    <a-entity position="0 1.6 3">
        <a-camera look-controls wasd-controls="acceleration: 20"></a-camera>
    </a-entity>
    
</a-scene>

<script>
let currentModel = null;
const statusLog = document.getElementById('statusLog');
const modelContainer = document.getElementById('modelContainer');
const assets = document.getElementById('assets');

function log(message, type = 'loading') {
    const div = document.createElement('div');
    div.className = `status ${type}`;
    div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
    statusLog.insertBefore(div, statusLog.firstChild);
    
    // Keep only last 10 logs
    while (statusLog.children.length > 10) {
        statusLog.removeChild(statusLog.lastChild);
    }
    
    console.log(message);
}

function clearModel() {
    if (currentModel) {
        currentModel.remove();
        currentModel = null;
    }
    // Clear assets
    const oldAssets = assets.querySelectorAll('a-asset-item');
    oldAssets.forEach(asset => asset.remove());
}

function loadModel() {
    const filename = document.getElementById('fileInput').value.trim();
    if (!filename) {
        log('‚ùå Please enter a filename', 'error');
        return;
    }
    
    log(`üîÑ Attempting to load: ${filename}`, 'loading');
    clearModel();
    
    // Create asset
    const asset = document.createElement('a-asset-item');
    asset.id = 'currentModel';
    asset.src = filename;
    asset.crossOrigin = 'anonymous';
    assets.appendChild(asset);
    
    // Create model entity
    currentModel = document.createElement('a-entity');
    currentModel.setAttribute('gltf-model', '#currentModel');
    currentModel.setAttribute('shadow', 'cast: true; receive: true');
    
    // Event listeners
    currentModel.addEventListener('model-loaded', function(evt) {
        log('‚úÖ Model loaded successfully!', 'success');
        log('üéØ Model is now visible in the scene', 'success');
        
        // Try to get model info
        try {
            const model = evt.detail.model;
            if (model) {
                const box = new THREE.Box3().setFromObject(model);
                const size = box.getSize(new THREE.Vector3());
                log(`üìè Model size: ${size.x.toFixed(1)} x ${size.y.toFixed(1)} x ${size.z.toFixed(1)}`, 'success');
                
                // Auto-scale if too big or too small
                const maxSize = Math.max(size.x, size.y, size.z);
                let scale = 1;
                if (maxSize > 10) scale = 8 / maxSize;
                if (maxSize < 0.5) scale = 2 / maxSize;
                
                if (scale !== 1) {
                    currentModel.setAttribute('scale', `${scale} ${scale} ${scale}`);
                    log(`üîß Auto-scaled model by ${scale.toFixed(2)}x`, 'success');
                }
            }
        } catch (e) {
            log('‚ö†Ô∏è Could not analyze model size: ' + e.message, 'loading');
        }
    });
    
    currentModel.addEventListener('model-error', function(evt) {
        log('‚ùå Failed to load model!', 'error');
        log('üí° Check: File exists, correct path, CORS headers', 'error');
        log('üåê Try serving via HTTP server (python -m http.server)', 'error');
    });
    
    // Add to scene
    modelContainer.appendChild(currentModel);
    
    // Timeout check
    setTimeout(() => {
        if (!currentModel || !currentModel.hasLoaded) {
            log('‚è∞ Model loading timeout - check console for errors', 'error');
        }
    }, 15000);
}

function testModel() {
    log('üß™ Loading test model from web...', 'loading');
    document.getElementById('fileInput').value = 'https://cdn.glitch.com/36cb8393-65c6-408d-a538-055ada20431b/scene.gltf?1548967079572';
    loadModel();
}

// Auto-load on page start
window.addEventListener('load', () => {
    log('üöÄ Mine GLB Loader ready!', 'success');
    log('üìÅ Make sure your GLB file is in the same folder', 'loading');
    log('‚ö° Click "Load Model" to test your file', 'loading');
    
    // Try to auto-load default file
    setTimeout(() => {
        log('üîÑ Auto-loading mine_ar_map.glb...', 'loading');
        loadModel();
    }, 1000);
});

// Handle file drops
document.addEventListener('dragover', (e) => {
    e.preventDefault();
});

document.addEventListener('drop', (e) => {
    e.preventDefault();
    const files = e.dataTransfer.files;
    if (files.length > 0 && files[0].name.endsWith('.glb')) {
        const file = files[0];
        log(`üìé Dropped file: ${file.name}`, 'loading');
        
        // Create object URL
        const url = URL.createObjectURL(file);
        document.getElementById('fileInput').value = url;
        loadModel();
    }
});
</script>

</body>
</html>
